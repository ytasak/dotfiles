#!/bin/bash
#
# Dotfiles ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# macOSç”¨ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆã¨ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã†
#

set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†

# ============================================================================
# è‰²ä»˜ãå‡ºåŠ›ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
# ============================================================================
info()    { echo "âœ… $*"; }
warn()    { echo "âš ï¸  $*"; }
error()   { echo "âŒ $*" >&2; exit 1; }

# ============================================================================
# ãƒ‘ã‚¹è¨­å®š
# ============================================================================
HOME_DIR="$HOME"
DOTFILES_DIR="$HOME_DIR/dotfiles"
CONFIG_DIR="$HOME_DIR/.config"
CLAUDE_DIR="$HOME_DIR/.claude"
SSH_DIR="$HOME_DIR/.ssh"

# ============================================================================
# ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆé–¢æ•°
# å¼•æ•°: $1 = dotfileså†…ã®ã‚½ãƒ¼ã‚¹ãƒ‘ã‚¹, $2 = ãƒªãƒ³ã‚¯å…ˆã®ãƒ‘ã‚¹
# ============================================================================
create_symlink() {
    local src="$DOTFILES_DIR/$1"
    local dst="$2"

    # ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if [[ ! -e "$src" ]]; then
        warn "$1 ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        return 0
    fi

    # ãƒªãƒ³ã‚¯å…ˆãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã®å‡¦ç†
    if [[ -L "$dst" ]]; then
        # æ—¢ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®å ´åˆ
        local current_target
        current_target=$(readlink "$dst")
        if [[ "$current_target" == "$src" ]]; then
            warn "$1 ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—: æ—¢ã«æ­£ã—ã„ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ãŒå­˜åœ¨ã—ã¾ã™"
            return 0
        fi
    elif [[ -e "$dst" ]]; then
        # é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        warn "$1 ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—: æ—¢ã«ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"
        return 0
    fi

    # ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
    ln -s "$src" "$dst"
    info "$dst â†’ $src"
}

# ============================================================================
# ã‚³ãƒãƒ³ãƒ‰å­˜åœ¨ç¢ºèªé–¢æ•°
# ============================================================================
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# ============================================================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ============================================================================
echo "ğŸ”§ Dotfiles ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."

# dotfilesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
if [[ ! -d "$DOTFILES_DIR" ]]; then
    error "dotfilesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $DOTFILES_DIR"
fi

# ----------------------------------------------------------------------------
# å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
# ----------------------------------------------------------------------------
mkdir -p "$CONFIG_DIR"
mkdir -p "$CLAUDE_DIR"
mkdir -p "$SSH_DIR" && chmod 700 "$SSH_DIR"

# ----------------------------------------------------------------------------
# ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®ä½œæˆ
# ----------------------------------------------------------------------------

# ã‚·ã‚§ãƒ«è¨­å®š
create_symlink ".zshrc" "$HOME_DIR/.zshrc"

# ~/.configé…ä¸‹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
create_symlink "ghostty" "$CONFIG_DIR/ghostty"
create_symlink "mise"    "$CONFIG_DIR/mise"
create_symlink "zellij"  "$CONFIG_DIR/zellij"
create_symlink "helix"   "$CONFIG_DIR/helix"

# Claude Codeè¨­å®š
create_symlink "claude/CLAUDE.md"     "$CLAUDE_DIR/CLAUDE.md"
create_symlink "claude/settings.json" "$CLAUDE_DIR/settings.json"

# SSHè¨­å®š
create_symlink "ssh/config" "$SSH_DIR/config"

# ----------------------------------------------------------------------------
# miseã«ã‚ˆã‚‹ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ----------------------------------------------------------------------------
echo ""
echo "ğŸ“¦ mise ã§ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."

if ! command_exists mise; then
    warn "mise ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "   ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: https://mise.jdx.dev/getting-started.html"
else
    if mise install; then
        info "mise ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
    else
        warn "mise install ã«å¤±æ•—"
    fi
fi

# ----------------------------------------------------------------------------
# ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¡ˆå†…
# ----------------------------------------------------------------------------
echo ""
echo "ğŸ’¡ ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«"

ZSHRC_LOCAL="$HOME_DIR/.zshrc.local"
if [[ ! -f "$ZSHRC_LOCAL" ]]; then
    echo "GitHub Tokenãªã©ã®ç§˜å¯†æƒ…å ±ã‚’è¨­å®šã™ã‚‹å ´åˆ:"
    echo "  cp $DOTFILES_DIR/.zshrc.local.example $ZSHRC_LOCAL"
    echo "  chmod 600 $ZSHRC_LOCAL"
    echo "  # ã‚¨ãƒ‡ã‚£ã‚¿ã§ç·¨é›†ã—ã¦GITHUB_TOKENãªã©ã‚’è¨­å®š"
else
    info "~/.zshrc.local ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
fi

# ----------------------------------------------------------------------------
# å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# ----------------------------------------------------------------------------
echo ""
echo "ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"
echo ""
echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’å†èµ·å‹•ã™ã‚‹ã‹ã€\`source ~/.zshrc\` ã‚’å®Ÿè¡Œ"
